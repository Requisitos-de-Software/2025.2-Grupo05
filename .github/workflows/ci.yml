name: CI & Deploy

on:
  # SÃ³ roda em push para main (deploy) ou devel (validaÃ§Ã£o)
  push:
    branches: [main, devel]

  # Roda em PRs, mas sÃ³ se NÃƒO for push simultÃ¢neo
  pull_request:
    branches: [main, devel]
    types: [opened, synchronize, reopened]

jobs:
  # ===================================================================
  # JOB 1: ValidaÃ§Ã£o Completa
  # ===================================================================
  validate:
    name: "ğŸ” ValidaÃ§Ã£o Geral"
    runs-on: ubuntu-latest
    # Evita execuÃ§Ã£o duplicada: se for PR de uma branch do mesmo repo, pula o push
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && !contains(github.event.head_commit.message, 'Merge pull request'))

    steps:
      - name: ğŸ”¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ’¾ Instalar dependÃªncias Python
        run: |
          pip install -r requirements.txt
          pip install ruff

      - name: ğŸ¨ Ruff format (checar estilo)
        id: ruff-format
        run: ruff format --check .
        continue-on-error: true

      - name: ğŸ› Ruff check (bug/lint)
        id: ruff-check
        run: ruff check .
        continue-on-error: true

      - name: ğŸ Python syntax (animaÃ§Ãµes)
        id: python-syntax
        run: find . -name "*.py" -type f -exec python -m py_compile {} \;
        continue-on-error: true

      - name: ğŸ“š MkDocs build
        id: mkdocs-build
        run: mkdocs build --strict --verbose
        continue-on-error: true

      - name: ğŸ“ MarkdownLint
        id: markdown-lint
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md
            !site/**
            !node_modules/**
            !venv/**
        continue-on-error: true

      - name: âŒ Exibir comandos de correÃ§Ã£o se houver erros
        if: |
          steps.ruff-format.outcome == 'failure' ||
          steps.ruff-check.outcome == 'failure' ||
          steps.python-syntax.outcome == 'failure' ||
          steps.mkdocs-build.outcome == 'failure' ||
          steps.markdown-lint.outcome == 'failure'
        run: |
          echo "################################################################"
          echo "#         âŒ ERROS ENCONTRADOS - COMO CORRIGIR                  #"
          echo "################################################################"

          if [[ "${{ steps.ruff-format.outcome }}" == "failure" ]]; then
            echo "ğŸ¦„ Ruff format: ruff format ."
          fi

          if [[ "${{ steps.ruff-check.outcome }}" == "failure" ]]; then
            echo "â­ Ruff check: ruff check . --fix"
          fi

          if [[ "${{ steps.python-syntax.outcome }}" == "failure" ]]; then
            echo "ğŸ Python: python -m py_compile arquivo.py"
          fi

          if [[ "${{ steps.markdown-lint.outcome }}" == "failure" ]]; then
            echo "ğŸ“ Markdown: Corrija links vazios [Foto]() e [Link]()"
          fi

          if [[ "${{ steps.mkdocs-build.outcome }}" == "failure" ]]; then
            echo "ğŸ“š MkDocs: mkdocs build --strict"
          fi

          echo "################################################################"
          exit 1

  # ===================================================================
  # JOB 2: Deploy (SÃ“ em push para main)
  # ===================================================================
  deploy:
    name: "ğŸš€ Deploy"
    needs: validate
    runs-on: ubuntu-latest
    # Deploy APENAS em push para main (nunca em PRs)
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Instalar dependÃªncias
        run: pip install -r requirements.txt

      - name: Build docs
        run: mkdocs build --verbose

      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force --clean --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
