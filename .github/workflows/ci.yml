name: CI & Deploy

# Eventos bem especÃ­ficos para evitar duplicaÃ§Ã£o
on:
  push:
    branches: [main] # Push sÃ³ para main
  pull_request:
    branches: [main, devel] # PRs para main ou devel
    types: [opened, synchronize, reopened]

jobs:
  # ===================================================================
  # JOB ÃšNICO: ValidaÃ§Ã£o + Deploy Condicional
  # ===================================================================
  ci-and-deploy:
    name: "ğŸ” CI & Deploy"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ’¾ Instalar dependÃªncias
        run: |
          pip install -r requirements.txt
          pip install ruff

      # ============ VALIDAÃ‡ÃƒO ============
      - name: ğŸ¨ Ruff format
        id: ruff-format
        run: ruff format --check .
        continue-on-error: true

      - name: ğŸ› Ruff check
        id: ruff-check
        run: ruff check .
        continue-on-error: true

      - name: ğŸ Python syntax
        id: python-syntax
        run: find . -name "*.py" -type f -exec python -m py_compile {} \;
        continue-on-error: true

      - name: ğŸ“š MkDocs build
        id: mkdocs-build
        run: mkdocs build --strict --verbose
        continue-on-error: true

      - name: ğŸ“ MarkdownLint
        id: markdown-lint
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md
            !site/**
            !node_modules/**
            !venv/**
        continue-on-error: true

      # ============ VERIFICAÃ‡ÃƒO DE ERROS ============
      - name: âŒ Verificar erros e mostrar correÃ§Ãµes
        if: |
          steps.ruff-format.outcome == 'failure' ||
          steps.ruff-check.outcome == 'failure' ||
          steps.python-syntax.outcome == 'failure' ||
          steps.mkdocs-build.outcome == 'failure' ||
          steps.markdown-lint.outcome == 'failure'
        run: |
          echo "################################################################"
          echo "#         âŒ ERROS ENCONTRADOS - COMO CORRIGIR                  #"
          echo "################################################################"

          if [[ "${{ steps.ruff-format.outcome }}" == "failure" ]]; then
            echo "ğŸ¦„ Ruff format: ruff format ."
          fi

          if [[ "${{ steps.ruff-check.outcome }}" == "failure" ]]; then
            echo "â­ Ruff check: ruff check . --fix"
          fi

          if [[ "${{ steps.python-syntax.outcome }}" == "failure" ]]; then
            echo "ğŸ Python: python -m py_compile arquivo.py"
          fi

          if [[ "${{ steps.markdown-lint.outcome }}" == "failure" ]]; then
            echo "ğŸ“ Markdown: Corrija links vazios [Foto]() e [Link]()"
          fi

          if [[ "${{ steps.mkdocs-build.outcome }}" == "failure" ]]; then
            echo "ğŸ“š MkDocs: mkdocs build --strict"
          fi

          echo "################################################################"
          exit 1

      # ============ DEPLOY (SÃ“ SE TUDO OK E FOR PUSH PARA MAIN) ============
      - name: ğŸš€ Deploy to GitHub Pages
        if: |
          success() && 
          github.event_name == 'push' && 
          github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ“š Fazendo deploy da documentaÃ§Ã£o..."
          mkdocs gh-deploy --force --clean --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============ NOTIFICAÃ‡ÃƒO DE SUCESSO ============
      - name: âœ… Sucesso
        if: success()
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "âœ… Pull Request validado com sucesso!"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "âœ… Deploy realizado com sucesso!"
            echo "ğŸ“š Site: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          else
            echo "âœ… ValidaÃ§Ã£o concluÃ­da com sucesso!"
          fi
