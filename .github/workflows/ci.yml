name: CI - Docs & Code

on:
  # Roda a pipeline em todo push e PR para main e devel
  push:
    branches:
      - main
      - devel
  pull_request:
    branches:
      - main
      - devel
    types: [opened, synchronize, reopened]

jobs:
  # ===================================================================
  # 1¬∫ JOB: Valida√ß√£o Geral de C√≥digo, Markdown e Documenta√ß√£o
  # ===================================================================
  ci:
    name: "üîç CI: Valida√ß√£o Geral"
    runs-on: ubuntu-latest

    steps:
      # Checkout do c√≥digo do reposit√≥rio
      - name: üî¶ Checkout
        uses: actions/checkout@v4

      # Prepara o Python para tarefas do projeto
      - name: üß∞ Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Instala depend√™ncias Python do projeto e ferramentas de lint
      - name: üíæ Instalar depend√™ncias Python
        run: |
          pip install -r requirements.txt
          pip install ruff

      # Checa se o formato do c√≥digo Python segue o padr√£o (PEP 8 e Black/Ruff)
      - name: üé® Ruff format (checar estilo)
        id: ruff-format
        run: |
          ruff format --check .
        continue-on-error: true

      # Faz lint completo, apontando poss√≠veis bugs e antipadr√µes no Python
      - name: üõÅ Ruff check (bug/lint)
        id: ruff-check
        run: |
          ruff check .
        continue-on-error: true

      # Verifica a sintaxe de todos os arquivos Python do reposit√≥rio (ex.: anima√ß√µes)
      - name: üêç Python syntax (anima√ß√µes)
        id: python-syntax
        run: |
          find . -name "*.py" -type f -exec python -m py_compile {} \;
        continue-on-error: true

      # Build da documenta√ß√£o com MkDocs (valida links, estrutura, nav etc)
      - name: üìö MkDocs build
        id: mkdocs-build
        run: |
          mkdocs build --strict --verbose
        continue-on-error: true

      # Faz an√°lise de estilo dos arquivos Markdown usando markdownlint-cli2 (Action do GitHub)
      - name: üìù MarkdownLint (markdownlint-cli2)
        id: markdown-lint
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md
            !site/**
            !node_modules/**
            !venv/**
        continue-on-error: true

      # Verifica se algum step falhou e exibe os comandos de corre√ß√£o
      - name: ‚ùå Exibir comandos de corre√ß√£o se houver erros
        if: |
          steps.ruff-format.outcome == 'failure' ||
          steps.ruff-check.outcome == 'failure' ||
          steps.python-syntax.outcome == 'failure' ||
          steps.mkdocs-build.outcome == 'failure' ||
          steps.markdown-lint.outcome == 'failure'
        run: |
          echo "################################################################"
          echo "#         ‚ùå ERROS ENCONTRADOS - COMO CORRIGIR                  #"
          echo "################################################################"

          # Verifica cada step individualmente e mostra comandos espec√≠ficos
          if [[ "${{ steps.ruff-format.outcome }}" == "failure" ]]; then
            echo "ü¶Ñ Ruff format: Corrija estilo automaticamente:"
            echo "  ruff format ."
            echo ""
          fi

          if [[ "${{ steps.ruff-check.outcome }}" == "failure" ]]; then
            echo "‚≠ê Ruff check: Visualize/corrija bugs/erros:"
            echo "  ruff check . --fix"
            echo ""
          fi

          if [[ "${{ steps.python-syntax.outcome }}" == "failure" ]]; then
            echo "üêç Python: Corrija sintaxe dos scripts Python:"
            echo "  python -m py_compile arquivo.py"
            echo ""
          fi

          if [[ "${{ steps.markdown-lint.outcome }}" == "failure" ]]; then
            echo "üìù Markdown: Corrija links vazios como [Foto]() e [Link da segunda reuni√£o]():"
            echo "  # Substitua [Foto]() por [Foto](caminho/para/imagem.jpg)"
            echo "  # Substitua [Link da segunda reuni√£o]() por [Link da segunda reuni√£o](url-real)"
            echo "  # Ou remova os links vazios se n√£o foram necess√°rios"
            echo ""
          fi

          if [[ "${{ steps.mkdocs-build.outcome }}" == "failure" ]]; then
            echo "üìö MkDocs: Verifique estrutura/links:"
            echo "  mkdocs build --strict"
            echo ""
          fi

          echo "################################################################"
          exit 1

  # ===================================================================
  # 2¬∫ JOB: Deploy da documenta√ß√£o (S√ì se todas as valida√ß√µes passarem)
  # ===================================================================
  deploy:
    name: "üöÄ Deploy Docs"
    needs: ci
    runs-on: ubuntu-latest
    # S√≥ faz deploy se todas valida√ß√µes passaram, push na main (n√£o PRs)
    if: ${{ success() && github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    steps:
      # Checkout da branch main para deploy final
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Prepara Python para rodar o MkDocs
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Instala somente o necess√°rio para gerar docs
      - name: Instalar depend√™ncias MkDocs
        run: |
          pip install -r requirements.txt

      # Gera build da documenta√ß√£o do zero
      - name: Build docs
        run: mkdocs build --verbose

      # Faz deploy do site para o GitHub Pages (gh-pages branch)
      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force --clean --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
